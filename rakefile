#
# The documentation server build script.
#

require 'find'
require 'rake'
require 'rake/clean'

#require 'yaml'
#require 'rubygems'
#require 'json'

TMP_DIR = "/tmp"

# Load other rake tasks
Dir.glob('tasks/*.rake') {|f| load(f) }

#-----------------------------------------------------
# Helper methods
#-----------------------------------------------------
def highlight(message, length=nil)
  stars = '*' * ((length or message.length) + 4)
  return ["", stars, "* #{message} *", stars, "", ""].join("\n")
end

def colorize(message, color=:red)
  colors = { :red => "31", :green => "32" }
  return "\e[#{colors[color]}m#{message}\e[0m"
end

def lowlight(message)
  to_print = "FAILURE: #{message}"
  raw_length = to_print.length

  to_print = colorize(to_print, :red) if $stdout.isatty

  return highlight(to_print, raw_length)
end

def notice(message)
  $stderr.puts highlight(message)
end

def check_env_var(variables)
  missing = variables.find_all { |v| ENV[v] == nil }
  raise "The following variables are missing and are needed to run this script: #{missing.join(', ')}." unless missing.empty?
end

#-----------------------------------------------------
# Installation methods
#-----------------------------------------------------

TARCMD = {
    "tar.gz" => "xvfz",
    "tar.bz2" => "xvfj"
}

def install_pkg(apps)
  notice("Installing #{apps.join(' ')}")
  sh("sudo apt-get -y install #{apps.join(' ')}")
end

def remove_pkg(apps)
  notice("Removing #{apps.join(' ')}")
  sh("sudo apt-get -y remove #{apps.join(' ')}")
end

def install_ppa(ppa)
  sh("sudo add-apt-repository \"#{ppa}\" && sudo apt-get update")
  notice("Installed ppa #{ppa}")
end

def install_gems(gems)
  all_gems = "#{gems.sort.join(' ')}"
  sh("sudo gem install #{all_gems}")
  notice("Installed #{all_gems}")
end

def upgrade_gems(gems)
  all_gems = "#{gems.sort.join(' ')}"
  sh("sudo gem install -u #{all_gems}")
  notice("Upgraded #{all_gems}")
end

def _download_tar(url, tarfile, tarcmd="xvfz")
  notice("Downloading tarfile #{tarfile}")
  sh("wget #{url} -O #{tarfile}") unless File.exists?(tarfile)
  
  notice("Untarring tarfile #{tarfile}")
  sh("tar #{tarcmd} #{tarfile}") if File.exists?(tarfile)
end

def download_tar(url, version, target, options={})
  ext = options[:ext] || "tar.gz"
  dir = options[:dir] || TMP_DIR
  block = options[:block]
  
  tarfile = "#{version}.#{ext}"
  tarcmd = TARCMD[ext]
  pwd = FileUtils.pwd()

  FileUtils.cd(dir) do
    begin
      _download_tar(url, tarfile, tarcmd)
      block.call if block
    ensure
      FileUtils.mv(target, pwd, :verbose => true) if File.exists?(target)
      FileUtils.rm(tarfile, :verbose => true) if File.exists?(tarfile)
    end
  end
end

def install_tar(url, version, options={})
  ext = options[:ext] || "tar.gz"
  dir = options[:dir] || TMP_DIR
  block = options[:block]

  tarfile = "#{version}.#{ext}"
  tarcmd = TARCMD[ext]
  notice("Installing tarfile #{tarfile}")
  FileUtils.cd(dir) do
    begin
      _download_tar(url, tarfile, tarcmd)

      FileUtils.cd(version) do
        sh("./configure") if File.exists?("configure")
        sh("make && sudo make install") unless Dir.glob("[Mm]akefile").empty?
        block.call if block
      end
    ensure
      FileUtils.rm(tarfile, :verbose => true)
    end
  end
end

def install_deb(url, debfile, dir=TMP_DIR)
  notice("Installing debfile #{debfile}")
  begin
    FileUtils.cd(dir) do
      sh("wget #{url} -O #{debfile} && sudo dpkg -i #{debfile}")
    end
  ensure
    FileUtils.rm(debfile) if File.exists?(debfile)
  end
end

def pip_install_pkg(pkg)
  notice("pip-installing #{pkg.join(' ')}")
  sh("sudo pip install #{pkg.join(' ')}")
end
